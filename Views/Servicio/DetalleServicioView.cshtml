@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using Syncfusion.EJ2;
@using ProyectoAlmaInicio.Models;
@using Syncfusion.EJ2.DropDowns;
@using Syncfusion.EJ2.Navigations;

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmFthGxyCA9bKVIfiTXuRCEYls3hpm6Zs"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="js/sb-admin.min.js"></script>

<div class="main-content" id="main-text">
    <div class="sidebar-content">
        <h4 class="h4">DETALLE DE SERVICIO</h4>
        <hr style="border-width: medium;" />
            <br>
                <div class="row">
                    <div class="col-lg-12">
                        <table id="DetalleServicio" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th class="tr" key="contenedorservicio">CONTENEDOR</th>
                                    <th class="tr" key="bookingservicio">BOOKING</th>
                                    <th class="tr" key="commodityservicio">COMMODITY</th>
                                    <th class="tr" key="navieraservicio">NAVIERA</th>
                                    <th class="tr" key="naveservicio">NAVE</th>
                                    <th class="tr" key="puertoorigenservicio">PUERTO ORIGEN</th>
                                    <th class="tr" key="puertodestinoservicio">PUERTO DESTINO</th>
                                    <th class="tr" key="fechainicioservicio">INICIO SERVICIO</th>
                                    <th class="tr" key="etapodservicio">ETA POD</th>
                                    <th class="tr" key="setpointacservicio">SETPOINT CO2</th>
                                    <th class="tr" key="setpointservicio">SETPOINT T°</th>
                                    <th class="tr" key="co2externo">C/SENSOR CO2</th>
                                    <th class="tr" key="tempexterna">C/SENSOR T°</th>
                                    <th class="tr" style="width:auto;" key="sensorluz">C/SENSOR APERTURA PUERTA</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            <br>

            <div class="divgraficoCO2 x_title row">
                <div class="col-lg-12">
                    <h4 class="h4" key="GraficoComportamiento">GRÁFICOS DE COMPORTAMIENTO DEL SERVICIO</h4>
                    <iframe id="Grafico" style="display:block; overflow:hidden; " scrolling="no" width="100%" height="320px"></iframe>
                    <div id="ModemInactivo" style="display:none;">
                        <br>
                        <p class="tr" key="ContactaLiventus"> Solicita a tu contacto habitual de Liventus S.A un modem Alma para la visualización del gráfico. </p>
                    </div>
                </div>
            </div>

            <br>
            <div class="divmapaLogistico x_title row">
                <div class="col-lg-12" id="TrazabilidadMapa" style="display:block;">
                    <h4 class="h4" key="TrazabilidadLogistica">TRAZABILIDAD LOGÍSTICA DEL SERVICIO</h4>
                    <div id="googleMap" key="AIzaSyAodWcupFgDhnsbvzZo8Dxe7W2gojsWFQE" style="width:100%;height:500px;border:2px solid #999999;"></div>
                </div>

                <div class="col-lg-12" id="ModemInactivoMapa" style="display:none;">
                    <h4 class="h4" key="TrazabilidadLogistica">TRAZABILIDAD LOGÍSTICA DEL SERVICIO</h4>
                    <div>
                        <br>
                        <p class="tr" key="ContactaLiventus"> Solicita a tu contacto habitual de Liventus S.A un modem Alma para la visualización del gráfico. </p>
                    </div>
                </div>
            </div>

        <div class="row">
            <div class="col-lg-12">
                <hr />
                <b>
                    Confidentiality Notice:
                </b> 
                <p>
                    <i>
                        La información aquí contenida es provista por un sistema de geolocalización. Pueden existir errores o distorsiones de ubicación que no necesariamente impliquen movimientos reales. Mientras la Aplicación Alma® se mantenga en periodo de pruebas, recomendamos validar mediante la utilización de su sistema de tracking habitual. En caso de dudas, solicitar mayor información a su contacto habitual de Liventus S.A. La información aquí contenida es preliminar, obtenida en base a un sistema de interconexión remoto vía 3G, y que puede sufrir modificaciones. Toda la información y los datos que la presente plataforma proporciona tienen carácter meramente informativo. Los autores no se hacen responsables de su exactitud, actualización o validez, y por tanto están exentos de toda responsabilidad derivada de su incorrección, omisión, falta de actualización o retraso, así como de cualquier pérdida, o daño que pudiera causar su uso o exposición por parte de terceros (autorizados o no). Toda la información se proporciona en los términos en que se visualiza, pudiendo no ser exactamente correcta, acertada o definitiva. Cualquier forma no autorizada de distribución, copia, duplicación, reproducción, o venta (total o parcial) del contenido de esta web, tanto para uso personal como comercial, constituirá una infracción de los derechos de propiedad de los autores. El Usuario se compromete a no utilizar cualquiera de los Contenidos que la plataforma ponga a su disposición para desarrollar actividades contrarias a las leyes, a la moral o al orden público y, en general, a hacer un uso conforme a las presentes condiciones generales. En cualquier caso, el usuario se compromete a mantener la estricta confidencialidad de la información técnica a la que pudiera acceder, gestionando su uso de manera interna, y no utilizando dicha información para afectar derechos o fundar reclamos en contra de terceros.
                    </i>
                </p> 
                <hr />
            </div>
        </div>
    </div>
</div>

<style>
     .e-card{
                font-family: Gotham Medium !important;
            }
            .e-tab{
                font-family: Gotham Medium !important;
            }
            .e-tab-text{
                font-family: Gotham Medium !important;
            }
            .e-control{
                font-family: Gotham Medium !important;
            }
            .e-treeview.e-list-text{
                color:white !important;
                font-family: Gotham Medium !important;
            } 

            .h4
            {
                color: black !important;
                font-family: Gotham Medium !important;
            }

            .main-content {
                background: #F7F7F7 !important;
                font-family: Gotham Medium !important;
            }

            .row
            {
                color: black !important;
                
            }

    .divgraficoCO2,
    .divmapaLogistico,
    .table
    {
        color: black !important;
    }
    .tr{
        width: auto !important;
    }

</style>
       <script>
    //var lenguaje = getCookie("Lenguaje");

    var ubicacion = { IdModem: "0", Latitud: "0", Longitud: "0" };
    var ubicacionesLista = [], UbicacionesEmerson = [];
    var IdControlador;
    var FechaControlador;
    var cuenta;

    $(document).ready(function () {

        $.ajax({
            type: "POST",
            url: '@Url.Action("SetTrazabilidadVista", "Trazabilidad")',
            dataType: 'json',
            dataSrc: '',
            data: {
                TipoVista: 2,
                NombreVista: 'DetalleServicioView'
            }

        });

        let params = new URLSearchParams(location.search);
        var IdServicio = params.get('IdServicio');
        var Contenedor, Booking, Commodity, Naviera, Nave, PuertoOrigen, PuertoDestino, EtaPuerto, EtaPuerto5, SetpointAC, SetpointT, Modem, CO2Ext, TemperaturaExt, AperturaPuerta;
        var RangoAltoCO2, RangoBajoCO2, RangoAltoO2, RangoBajoO2;
        var PaltaMax, PaltaMin, ArandanoMax, AranadanoMin, DuraznoNectarinMax, DuraznoNectarinMin, CiruelaMax, CiruelaMin, EsparragoMax, EsparragoMin;

        @*  por ahora no
        $.ajax({
            type: "POST",
            url: '@Url.Action("SetTrazabilidadVista", "Trazabilidad")',
            dataType: 'json',
            dataSrc: '',
            data: {
                TipoVista: 2,
                NombreVista: 'DETALLESERVICIOVIEW'
            });*@

        $.ajax({
            type: "POST",
            url: '@Url.Action("GetMapaLogistico", "DetalleServicio")',
            data: { IdServicio: IdServicio },
            dataType: 'json',
            dataSrc: '',
            async: false,
            success: function (response) {
                IdControlador = response.IdControlador;
                //tFechaControlador = FormatDateControlador(response.FechaControlador);
                ubicacionesLista = response.UbicacionHistModem;

                UbicacionesEmerson = response.UbicacionHistEmerson;

                if (response.Contenedor == null) { Contenedor = ""; }
                else { Contenedor = response.Contenedor; }
                if (response.Booking == null) { Booking = ""; }
                else { Booking = response.Booking; }
                if (response.Commodity == null) { Commodity = ""; }
                else { Commodity = response.Commodity; }
                if (response.Naviera == null) { Naviera = ""; }
                else { Naviera = response.Naviera; }
                if (response.Nave == null) { Nave = ""; }
                else { Nave = response.Nave; }
                if (response.PuertoOrigen == null) { PuertoOrigen = ""; }
                else { PuertoOrigen = response.PuertoOrigen; }
                if (response.PuertoDestino == null) { PuertoDestino = ""; }
                else { PuertoDestino = response.PuertoDestino; }
                if (response.FechaControlador == null) { FechaControlador = ""; }
                else { FechaControlador = FormatDateControlador(response.FechaControlador); }
                if (response.EtaPuerto == null) { EtaPuerto = ""; }
                else { EtaPuerto = FormatDate(response.EtaPuerto); }
                if (response.EtaPuerto5 == null) { EtaPuerto5 = ""; }
                else { EtaPuerto5 = FormatDate(response.EtaPuerto5); }

                if (response.SetpointAC == null) { SetpointAC = ""; }
                else { SetpointAC = response.SetpointAC; }
                if (response.SetpointT == null) { SetpointT = ""; }
                else { SetpointT = response.SetpointT; }
                if (response.Modem == null) { Modem = ""; }
                else { Modem = response.Modem; }
                if (response.CO2Ext == null) { CO2Ext = ""; }
                else { CO2Ext = response.CO2Ext; }
                if (response.TemperaturaExt == null) { TemperaturaExt = ""; }
                else { TemperaturaExt = response.TemperaturaExt; }
                if (response.AperturaPuerta == null) { AperturaPuerta = ""; }
                else { AperturaPuerta = response.AperturaPuerta; }


                PaltaMax = 5;
                PaltaMin = 12;
                ArandanoMax = 8;
                AranadanoMin = 16;
                DuraznoNectarinMax = 12;
                DuraznoNectarinMin = 17;
                CiruelaMax = 5;
                CiruelaMin = 10;
                EsparragoMax = 10;
                EsparragoMin = 14;

                if (Commodity == "AVOCADOS") {
                    RangoAltoCO2 = PaltaMax;
                    RangoBajoCO2 = PaltaMin;
                } else if (Commodity == "BLUEBERRIES") {
                    RangoAltoCO2 = ArandanoMax;
                    RangoBajoCO2 = AranadanoMin;
                } else if (Commodity == "NECTARINES" || Commodity == "PEACHES") {
                    RangoAltoCO2 = DuraznoNectarinMax;
                    RangoBajoCO2 = DuraznoNectarinMin;
                } else if (Commodity == "PLUMS") {
                    RangoAltoCO2 = CiruelaMax;
                    RangoBajoCO2 = CiruelaMin;
                } else if (Commodity == "ASPARAGUS") {
                    RangoAltoCO2 = EsparragoMax;
                    RangoBajoCO2 = EsparragoMin;
                }

                 body = "<tr>";
                body += "<td>" + Contenedor + "</td>";
                body += "<td>" + Booking + "</td>";
                body += "<td>" + Commodity + "</td>";
                body += "<td>" + Naviera + "</td>";
                body += "<td>" + Nave + "</td>";
                body += "<td>" + PuertoOrigen + "</td>";
                body += "<td>" + PuertoDestino + "</td>";
                body += "<td>" + FechaControlador + "</td>";
                body += "<td>" + EtaPuerto + "</td>";
                body += "<td>" + SetpointAC + "</td>";
                body += "<td>" + SetpointT + "</td>";
                body += "<td>" + CO2Ext + "</td>";
                body += "<td>" + TemperaturaExt + "</td>";
                body += "<td>" + AperturaPuerta + "</td>";
                body += "</tr>";

                $("#DetalleServicio tbody").append(body);


                if (response.Modem == 'NO') {
                    SinModem();
                }

                /*if (lenguaje == "es") {
                    document.getElementById("Grafico").src = "http://132.255.70.203/Grafico/GraficoAlmaSensoresFinal.php?Controller=" + IdControlador + "&Fecha=" + FechaControlador + "&FechaPOD=" + EtaPuerto5 + "&RangoAltoCO2=" + RangoAltoCO2 + "&RangoBajoCO2=" + RangoBajoCO2;
                } else {
                    document.getElementById("Grafico").src = "http://132.255.70.203/Grafico/GraficoAlmaSensoresEnglish.php?Controller=" + IdControlador + "&Fecha=" + FechaControlador + "&FechaPOD=" + EtaPuerto5; //"&RangoAltoCO2=" + RangoAltoCO2 + "&RangoBajoCO2=" + RangoBajoCO2 +
                }*/

                document.getElementById("Grafico").src = "http://132.255.70.203/Grafico/GraficoAlmaSensoresFinal.php?Controller=" + IdControlador + "&Fecha=" + FechaControlador + "&FechaPOD=" + EtaPuerto5 + "&RangoAltoCO2=" + RangoAltoCO2 + "&RangoBajoCO2=" + RangoBajoCO2;

                //$('#GraficoUnitarioModal').trigger('click');

                init();

                /*var grid = document.getElementById("DetalleServicio").ej2_instances[0];
                grid.Datasource = 'ViewBag.servicio';
                grid.refresh();*/

            }

        });


        function FormatDate(data) {
            var dateString = data.substr(6);
            var currentTime = new Date(parseInt(dateString));
            var month = currentTime.getMonth() + 1;
            var day = currentTime.getDate();
            var year = currentTime.getFullYear();

            if (month < 10) {
                month = "0" + month;
            } else {
                month;
            }

            if (day < 10) {
                day = "0" + day;
            } else {
                day;
            }

            var date = day + "-" + month + "-" + year;
            return date;
        }

        function FormatDateControlador(data) {
            var dateString = data.substr(6);
            var currentTime = new Date(parseInt(dateString));
            var month = currentTime.getMonth() + 1;
            var day = currentTime.getDate();
            var year = currentTime.getFullYear();
            var Hora = currentTime.getHours();
            var Minutos = currentTime.getMinutes();

            if (month < 10) {
                month = "0" + month;
            } else {
                month;
            }

            if (day < 10) {
                day = "0" + day;
            } else {
                day;
            }

            if (Hora < 10 && Hora != 0) {
                Hora = "0" + Hora;
            } else if (Hora == 0) {
                Hora = "00";
            } else {
                Hora;
            }

            if (Minutos < 10 && Minutos != 0) {
                Minutos = "0" + Minutos;
            } else if (Minutos == 0) {
                Minutos = "00";
            } else {
                Minutos;
            }

            var date = day + "-" + month + "-" + year + " " + Hora + ":" + Minutos;
            return date;
        }
    });

    function SinModem() {
        document.getElementById("TrazabilidadMapa").style.display = 'none';
        document.getElementById("Grafico").style.display = 'none';

        document.getElementById("ModemInactivo").style.display = 'block';
        document.getElementById("ModemInactivoMapa").style.display = 'block';
    }

    function FormatDateControlador(data) {
        var dateString = data.substr(6);
        var currentTime = new Date(parseInt(dateString));
        var month = currentTime.getMonth() + 1;
        var day = currentTime.getDate();
        var year = currentTime.getFullYear();
        var Hora = currentTime.getHours();
        var Minutos = currentTime.getMinutes();

        if (month < 10) {
            month = "0" + month;
        } else {
            month;
        }

        if (day < 10) {
            day = "0" + day;
        } else {
            day;
        }

        if (Hora < 10 && Hora != 0) {
            Hora = "0" + Hora;
        } else if (Hora == 0) {
            Hora = "00";
        } else {
            Hora;
        }

        if (Minutos < 10 && Minutos != 0) {
            Minutos = "0" + Minutos;
        } else if (Minutos == 0) {
            Minutos = "00";
        } else {
            Minutos;
        }

        var date = day + "-" + month + "-" + year + " " + Hora + ":" + Minutos;
        return date;
    }

    function init() {

        var latlng = new google.maps.LatLng(0, 0);
        var latlngCenter = new google.maps.LatLng(0, 0);
        var travelCoordinates = [];
        var cordenada;
        cuenta = ubicacionesLista.length;

        // Configuración del mapa
        var mapProp = {
            zoom: 3,
            center: latlngCenter,
            mapTypeId: google.maps.MapTypeId.ROADMAP,    //puede ser TERRAIN
            disableDefaultUI: true,
            zoomControl: true,
            mapTypeControl: false,
            scaleControl: false,
            streetViewControl: false,
            fullscreenControl: true
        };

        // Agregando el mapa al tag de id googleMap
        var map = new google.maps.Map(document.getElementById("googleMap"), mapProp);


        for (var i = 0 ; i < cuenta ; i++) {

            var latlng = new google.maps.LatLng(ubicacionesLista[i].Latitud, ubicacionesLista[i].Longitud);

            var myinfowindow = new google.maps.InfoWindow({
                content: '<div class="infoWindow" <p> Actualización: <b> ' + FormatDateControlador(ubicacionesLista[i].FechaUbicacion) + ' </b> </p> </div>',
                maxWidth: 230
            });

            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                //title: 'Container ' + i + (1),
                draggable: false,
                infoWindow: myinfowindow
            });

            google.maps.event.addDomListener(map, 'click', function () {
                infoWindow.close();
            });

            google.maps.event.addListener(marker, 'click', function () {
                //marker.getPosition();

                this.infoWindow.open(map, this);
            });
            //crearMarket(latlng);
            cordenada = { lat: parseFloat(ubicacionesLista[i].Latitud), lng: parseFloat(ubicacionesLista[i].Longitud) };

            travelCoordinates.push(cordenada);
            marker.setMap(map);

        }


        // Información de la ruta (coordenadas, color de línea, etc...)
        var travel = new google.maps.Polyline({
            path: travelCoordinates,
            geodesic: false,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        travel.setMap(map);
    }

</script>

<script id="coltemplateOrigen" type="text/x-template">
    <div class="image">
        <img src="@Url.Content("~/Content/grid/Map.png")" class="e-image" alt="${PuertoOrigen}" /> &nbsp
        <span id="locationtext">${PuertoOrigen}</span>
    </div>
</script>

<script id="coltemplateDestino" type="text/x-template">
    <div class="image">
        <img src="@Url.Content("~/Content/grid/Map.png")" class="e-image" alt="${PuertoDestino}" /> &nbsp
        <span id="locationtext">${PuertoDestino}</span>
    </div>
</script>

<style>
    .gm-style-iw {
        height: 45px;
        width: 60%;
        padding-left: 20px;
        margin-left: 40px;
        float: left;
        line-height: 25px;
    }
</style>
